<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Crona — Agendador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/imask"></script>
  </head>
  <body class="min-h-screen bg-gray-50 text-gray-900">
    <main class="max-w-md mx-auto p-6">
      <h1 class="text-2xl text-align-center font-bold mb-4">
        Confirmar Agendamento no <span class="text-black">Crona</span>
      </h1>
      <p class="text-sm text-gray-600 mb-4">
        Informe seu CPF e selecione a data do agendamento.
      </p>

      <label class="block text-sm font-medium">CPF</label>
      <input
        id="cpf"
        class="mt-1 w-full rounded-xl border-gray-300 focus:border-black focus:ring-black px-3 py-2"
        placeholder="000.000.000-00"
      />

      <label class="block text-sm font-medium mt-4">Data do agendamento *</label>
      <select
        id="slot_data"
        class="mt-1 w-full rounded-xl border-gray-300 focus:border-black focus:ring-black px-3 py-2"
      >
        <option value="">Carregando datas…</option>
      </select>

      <button
        id="consultar"
        class="mt-4 w-full rounded-xl bg-black text-white px-4 py-2 font-semibold"
      >
        Continuar
      </button>
      <p id="msg" class="mt-3 text-sm"></p>
    </main>

    <script>
      const cpfEl = document.getElementById('cpf');
      const dataEl = document.getElementById('slot_data');
      const msgEl = document.getElementById('msg');

      // máscara
      IMask(cpfEl, { mask: '000.000.000-00' });

      const params = new URLSearchParams(window.location.search);
      const forcedDate = params.get('data');
      const sigParam = params.get('sig');

      // --------- CONFIG: ajuste as URLs das funções (Supabase Edge Functions) ---------
      const CRONA_FN_LOOKUP = window.CRONA_FN_LOOKUP || 'https://YOUR-PROJECT.functions.supabase.co/lookup_cpf';
      const CRONA_LIST_URL   = window.CRONA_LIST_URL   || 'https://YOUR-PROJECT.functions.supabase.co/list_slots';

      // Carrega as datas/slots ativos
      async function loadDatas() {
        dataEl.disabled = true;
        dataEl.innerHTML = '<option value="">Carregando datas…</option>';

        try {
          const r = await fetch(CRONA_LIST_URL);
          const j = await r.json();
          if (!j.ok) throw new Error(j.error || 'Falha ao listar');

          const items = j.items || [];
          if (!items.length) {
            dataEl.innerHTML =
              '<option value="">Sem datas ativas no momento</option>';
            return;
          }

          dataEl.innerHTML =
            '<option value="">Selecione</option>' +
            items
              .map(it => {
                const label =
                  it.vagas_restantes == null
                    ? `${it.data}${it.local ? ' — ' + it.local : ''}`
                    : `${it.data}${it.local ? ' — ' + it.local : ''} (${it.vagas_restantes} vagas)`;
                return `<option value="${it.data}">${label}</option>`;
              })
              .join('');
          dataEl.disabled = false;

          // Se veio ?data=, pré-seleciona SOMENTE se existir na lista
          if (forcedDate && [...dataEl.options].some(o => o.value === forcedDate)) {
            dataEl.value = forcedDate;
          }
        } catch (e) {
          console.error(e);
          dataEl.innerHTML = '<option value="">Erro ao carregar datas</option>';
        }
      }
      loadDatas();

      document.getElementById('consultar').addEventListener('click', async () => {
        const cpfDigits = (cpfEl.value || '').replace(/\D/g, '');
        const slot_data = (dataEl.value || '').trim();

        if (cpfDigits.length !== 11) {
          msgEl.textContent = 'CPF inválido.';
          msgEl.className = 'mt-3 text-sm text-rose-700';
          return;
        }
        if (!slot_data) {
          msgEl.textContent = 'Selecione a data do agendamento.';
          msgEl.className = 'mt-3 text-sm text-rose-700';
          return;
        }

        msgEl.textContent = 'Verificando…';
        msgEl.className = 'mt-3 text-sm text-gray-600';

        try {
          const r = await fetch(CRONA_FN_LOOKUP, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ cpf: cpfDigits, slot_data, sig: sigParam || null }),
          });
          const j = await r.json();

          if (j.status === 'SIGNED_FOR_DATE') {
            window.location.href = 'pages/ja-assinou.html';
            return;
          }

          const basePrefill = { cpf: cpfDigits, slot_data, _ts: Date.now(), sig: sigParam || null };
          const prefill = j.status === 'REGISTERED_NOT_SIGNED' && j.data ? { ...j.data, ...basePrefill } : basePrefill;

          sessionStorage.setItem('prefill', JSON.stringify(prefill));
          window.location.href = 'pages/termo.html';
        } catch (e) {
          console.error(e);
          msgEl.textContent = 'Erro ao consultar. Tente novamente.';
          msgEl.className = 'mt-3 text-sm text-rose-700';
        }
      });
    </script>
  </body>
</html>
